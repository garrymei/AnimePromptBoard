<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Prompt Board</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .prompt-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .category-item.selected {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .category-item h4 {
            margin-bottom: 8px;
            color: #495057;
        }

        .category-item p {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .import-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 1rem;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: #495057;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .prompt-input-area {
            margin-bottom: 20px;
        }

        .prompt-input-area label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
        }

        .prompt-input-area textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .prompt-input-area textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .prompt-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            min-height: 100px;
        }

        .prompt-preview.empty {
            color: #6c757d;
            text-align: center;
            font-style: italic;
        }

        .preview-category {
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            padding-left: 15px;
        }

        .preview-category h4 {
            color: #495057;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .preview-category .en-text {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #495057;
        }

        .preview-category .zh-text {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .import-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .entry-title-input,
        .entry-tags-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .entry-title-input:focus,
        .entry-tags-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .toolbar-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .toolbar-left {
            flex: 2;
            min-width: 400px;
        }

        .toolbar-right {
            flex: 1;
            min-width: 300px;
        }

        .data-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }

        .edit-categories {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }

        .edit-category {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }

        .edit-category h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .edit-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-bottom: 10px;
            resize: vertical;
        }

        .edit-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .edit-zh {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .copy-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .tag-editor {
            margin-bottom: 20px;
        }

        .tag-editor h4 {
            margin-bottom: 10px;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .tag-chip {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag-remove {
            background: none;
            border: none;
            color: #1976d2;
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
        }

        .tag-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }

        .edit-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            border-top: 2px solid #e9ecef;
            padding-top: 15px;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .search-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .tag-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tag:hover {
            background: #bbdefb;
        }

        .tag.selected {
            background: #1976d2;
            color: white;
        }

        .entries-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .entries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .entry-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            background: white;
        }

        .entry-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .entry-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid #e9ecef;
        }

        .entry-content {
            padding: 20px;
        }

        .entry-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
        }

        .entry-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .entry-tag {
            background: #f8f9fa;
            color: #6c757d;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .prompt-section {
            margin-bottom: 15px;
        }

        .prompt-category {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .prompt-text {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #495057;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
            word-break: break-all;
        }

        .prompt-text:hover {
            background: #e9ecef;
        }

        .prompt-chinese {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-btn {
            padding: 8px 15px;
            border: 2px solid #e9ecef;
            background: white;
            color: #495057;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .stats {
            text-align: center;
            margin-bottom: 20px;
            color: #6c757d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .search-row {
                flex-direction: column;
            }
            
            .entries-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 Anime Prompt Board</h1>
            <p>二次元提示词管理工具 - 本地存储，无需登录</p>
        </div>

        <!-- 导入区域 -->
        <div class="upload-section">
            <h3>📤 导入图片 & 提示词</h3>
            <div class="import-tabs">
                <button class="tab-btn active" id="imageTab">📷 选择图片</button>
                <button class="tab-btn" id="promptTab">📝 输入提示词</button>
            </div>
            
            <!-- 图片上传区域 -->
            <div class="tab-content active" id="imageContent">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <p>拖拽图片到此处，或点击选择文件</p>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-top: 10px;">
                        支持 PNG, JPG, JPEG, WebP 格式
                    </p>
                </div>
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
            </div>
            
            <!-- 提示词输入区域 -->
            <div class="tab-content" id="promptContent">
                <div class="prompt-input-area">
                    <label for="promptInput">输入8类提示词（支持自动分类）：</label>
                    <textarea id="promptInput" placeholder="请按以下格式输入提示词：

[Base Styles / 基础风格]
anime style, bishoujo character, Demon Slayer illustration

[Artistic Styles / 画风表现]
cel shading, manga lineart, vibrant pastel tones

[Cinematic / 摄影感]
cinematic composition, dynamic action shot, ultra-realistic rim lighting

[Lighting & Mood / 光影氛围]
glowing pastel light, soft bloom effect, moonlit battlefield atmosphere

[Theme Styles / 主题风格]
fantasy Japanese setting, traditional haori fluttering, supernatural battle theme

[Rendering / 渲染技术]
hyper-detailed, 8K resolution, subsurface scattering for skin

[Effects / 特效元素]
floating cherry blossoms, glowing energy ribbons, heart-shaped sparks

[Typography & Overlay / 文字与装饰]
calligraphic kanji overlay 「恋の呼吸」, dissolving brushstroke text, flowing mist captions"></textarea>
                </div>
                
                <div class="prompt-preview" id="promptPreview">
                    <!-- 预览区域 -->
                </div>
            </div>
            
            <div class="import-controls">
                <input type="text" id="entryTitle" placeholder="为这个条目起个名字..." class="entry-title-input">
                <input type="text" id="entryTags" placeholder="添加标签，用逗号分隔..." class="entry-tags-input">
                <button class="btn" id="importBtn" disabled>📥 导入条目</button>
                <button class="btn btn-secondary" id="clearBtn">🗑️ 清空</button>
                <button class="btn btn-secondary" id="addSampleBtn">➕ 添加示例数据</button>
            </div>
        </div>

        <!-- 工具栏 -->
        <div class="toolbar-section">
            <div class="toolbar-left">
                <h3>🔍 搜索 & 筛选</h3>
                <div class="search-row">
                    <input type="text" class="search-input" id="searchInput" placeholder="搜索标题、标签或提示词...">
                    <button class="btn" id="searchBtn">搜索</button>
                    <button class="btn btn-secondary" id="resetBtn">重置</button>
                </div>
                <div class="tag-filter" id="tagFilter">
                    <!-- 标签筛选器将动态生成 -->
                </div>
            </div>
            <div class="toolbar-right">
                <h3>📁 数据管理</h3>
                <div class="data-controls">
                    <button class="btn" id="exportBtn">📤 导出数据</button>
                    <button class="btn" id="importDataBtn">📥 导入数据</button>
                    <button class="btn btn-secondary" id="openDataBtn">📂 打开数据目录</button>
                </div>
            </div>
        </div>

        <!-- 条目列表 -->
        <div class="entries-section">
            <div class="stats" id="stats">
                <!-- 统计信息将动态生成 -->
            </div>
            
            <div class="entries-grid" id="entriesGrid">
                <!-- 条目卡片将动态生成 -->
            </div>
            
            <div class="pagination" id="pagination">
                <!-- 分页控件将动态生成 -->
            </div>
        </div>

        <!-- 编辑模态框 -->
        <div class="edit-modal" id="editModal">
            <div class="edit-content">
                <div class="edit-header">
                    <h2>编辑条目</h2>
                    <button class="btn btn-secondary" onclick="closeEditModal()">✕ 关闭</button>
                </div>
                
                <div class="tag-editor">
                    <h4>🏷️ 标签管理</h4>
                    <div class="tags-container" id="editTags">
                        <!-- 标签将动态生成 -->
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="tag-input" id="newTagInput" placeholder="输入新标签，按回车添加">
                        <button class="btn" onclick="addTag()">添加标签</button>
                    </div>
                </div>
                
                <div class="edit-categories" id="editCategories">
                    <!-- 提示词类别将动态生成 -->
                </div>
                
                <div class="edit-actions">
                    <button class="btn btn-danger" onclick="deleteEntry()">🗑️ 删除条目</button>
                    <div>
                        <button class="btn copy-btn" onclick="copyAllPrompts()">📋 复制全部英文提示词</button>
                        <button class="btn" onclick="saveEntry()">💾 保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let entries = [];
        let filteredEntries = [];
        let currentPage = 1;
        const itemsPerPage = 12;
        let selectedCategories = new Set();
        let allTags = new Set();
        let selectedFiles = [];

        // 8大类别映射（用于正则匹配）
        const categoryMapping = {
            'base_styles': {
                patterns: [/\[Base\s+Styles?\s*\/?\s*基础风格?\]/, /\[基础风格\s*\/?\s*Base\s+Styles?\]/],
                key: 'base_styles',
                name: '🎨 基础风格 (Base Styles)',
                zhName: '基础风格'
            },
            'artistic_styles': {
                patterns: [/\[Artistic\s+Styles?\s*\/?\s*画风表现?\]/, /\[画风表现\s*\/?\s*Artistic\s+Styles?\]/],
                key: 'artistic_styles', 
                name: '🖌️ 画风表现 (Artistic Styles)',
                zhName: '画风表现'
            },
            'cinematic': {
                patterns: [/\[Cinematic\s*\/?\s*摄影感?\]/, /\[摄影感\s*\/?\s*Cinematic\]/],
                key: 'cinematic',
                name: '🎬 摄影感 (Cinematic)',
                zhName: '摄影感'
            },
            'lighting_mood': {
                patterns: [/\[Lighting\s*&?\s*Mood\s*\/?\s*光影氛围?\]/, /\[光影氛围\s*\/?\s*Lighting\s*&?\s*Mood\]/],
                key: 'lighting_mood',
                name: '💡 光影氛围 (Lighting & Mood)',
                zhName: '光影氛围'
            },
            'theme_styles': {
                patterns: [/\[Theme\s+Styles?\s*\/?\s*主题风格?\]/, /\[主题风格\s*\/?\s*Theme\s+Styles?\]/],
                key: 'theme_styles',
                name: '🏮 主题风格 (Theme Styles)',
                zhName: '主题风格'
            },
            'rendering': {
                patterns: [/\[Rendering\s*\/?\s*渲染技术?\]/, /\[渲染技术\s*\/?\s*Rendering\]/],
                key: 'rendering',
                name: '⚙️ 渲染技术 (Rendering)',
                zhName: '渲染技术'
            },
            'effects': {
                patterns: [/\[Effects?\s*\/?\s*特效元素?\]/, /\[特效元素\s*\/?\s*Effects?\]/],
                key: 'effects',
                name: '✨ 特效元素 (Effects)',
                zhName: '特效元素'
            },
            'typography': {
                patterns: [/\[Typography\s*&?\s*Overlay\s*\/?\s*文字与装饰?\]/, /\[文字与装饰\s*\/?\s*Typography\s*&?\s*Overlay\]/],
                key: 'typography',
                name: '📝 文字与装饰 (Typography & Overlay)',
                zhName: '文字与装饰'
            }
        };

        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 检查 API 是否正确加载
            console.log('Checking window.api:', window.api);
            if (!window.api) {
                console.error('window.api is not available! Preload script may have failed.');
                alert('应用初始化失败：API 不可用。请检查控制台错误信息。');
                return;
            }
            
            // 检查必要的 API 方法
            const requiredMethods = ['listEntries', 'saveEntries', 'saveMediaDataURL', 'resolveMediaURL', 'openUserData', 'exportJSON', 'importJSON'];
            const missingMethods = requiredMethods.filter(method => typeof window.api[method] !== 'function');
            
            if (missingMethods.length > 0) {
                console.error('Missing API methods:', missingMethods);
                alert(`缺少必要的API方法: ${missingMethods.join(', ')}`);
                return;
            }
            
            console.log('All APIs loaded successfully!');
            loadEntries();
            setupEventListeners();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 选项卡切换
            document.getElementById('imageTab').addEventListener('click', () => switchTab('image'));
            document.getElementById('promptTab').addEventListener('click', () => switchTab('prompt'));
            
            // 文件上传
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const importBtn = document.getElementById('importBtn');
            const clearBtn = document.getElementById('clearBtn');
            const addSampleBtn = document.getElementById('addSampleBtn');

            // 点击上传
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            
            // 拖拽上传 - 添加到上传区域和整个图片选项卡
            const imageContent = document.getElementById('imageContent');
            
            [uploadArea, imageContent].forEach(element => {
                element.addEventListener('dragenter', handleDragEnter);
                element.addEventListener('dragover', handleDragOver);
                element.addEventListener('dragleave', handleDragLeave);
                element.addEventListener('drop', handleDrop);
            });
            
            // 防止整个窗口的拖拽默认行为
            window.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            window.addEventListener('drop', (e) => {
                e.preventDefault();
            });
            
            // 提示词输入
            const promptInput = document.getElementById('promptInput');
            promptInput.addEventListener('input', debounce(parsePrompts, 300));
            
            // 标题和标签输入
            document.getElementById('entryTitle').addEventListener('input', checkImportReady);
            document.getElementById('entryTags').addEventListener('input', checkImportReady);
            
            // 按钮事件
            importBtn.addEventListener('click', importEntry);
            clearBtn.addEventListener('click', clearAll);
            addSampleBtn.addEventListener('click', addSampleData);

            // 搜索
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('resetBtn').addEventListener('click', resetSearch);
            document.getElementById('searchInput').addEventListener('input', debounce(performSearch, 300));

            // 数据管理
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', importData);
            document.getElementById('openDataBtn').addEventListener('click', openDataDir);

            // 编辑模态框
            document.getElementById('newTagInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTag();
            });
        }

        // 拖拽处理
        function handleDragEnter(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            // 只有当鼠标真正离开元素（而不是移动到子元素）时才移除样式
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('dragover');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            
            console.log('Drop event triggered');
            const files = Array.from(e.dataTransfer.files);
            console.log('All dropped files:', files);
            
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            console.log('Image files:', imageFiles);
            
            if (imageFiles.length > 0) {
                handleFiles(imageFiles);
            } else {
                alert('请拖拽图片文件（PNG, JPG, JPEG, WebP）');
            }
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }

        function handleFiles(files) {
            console.log('handleFiles called with:', files);
            if (files.length === 0) {
                console.log('No files provided');
                return;
            }
            
            selectedFiles = files;
            console.log('Files stored in selectedFiles:', selectedFiles);
            checkImportReady();
            
            // 更新上传区域显示
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">✅</div>
                <p>已选择 ${files.length} 个文件</p>
                <p style="font-size: 0.9rem; color: #6c757d; margin-top: 10px;">
                    ${files.map(f => f.name).join(', ')}
                </p>
                <p style="font-size: 0.8rem; color: #6c757d; margin-top: 5px;">
                    点击重新选择文件
                </p>
            `;
            
            console.log('Upload area updated');
        }

        // 选项卡切换
        function switchTab(tab) {
            // 更新选项卡按钮
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'image') {
                document.getElementById('imageTab').classList.add('active');
                document.getElementById('imageContent').classList.add('active');
            } else {
                document.getElementById('promptTab').classList.add('active');
                document.getElementById('promptContent').classList.add('active');
            }
            
            checkImportReady();
        }

        // 解析提示词文本
        function parsePrompts() {
            const promptText = document.getElementById('promptInput').value;
            const preview = document.getElementById('promptPreview');
            
            if (!promptText.trim()) {
                preview.innerHTML = '<p class="empty">请输入提示词文本...</p>';
                preview.className = 'prompt-preview empty';
                checkImportReady();
                return;
            }
            
            const parsedPrompts = parsePromptText(promptText);
            
            if (Object.keys(parsedPrompts).length === 0) {
                preview.innerHTML = '<p class="empty">未检测到有效的分类标签，请检查格式...</p>';
                preview.className = 'prompt-preview empty';
                checkImportReady();
                return;
            }
            
            // 显示预览
            preview.className = 'prompt-preview';
            preview.innerHTML = Object.entries(parsedPrompts).map(([key, data]) => `
                <div class="preview-category">
                    <h4>${data.categoryName}</h4>
                    <div class="en-text">${data.content}</div>
                    <div class="zh-text">${data.categoryZh}</div>
                </div>
            `).join('');
            
            checkImportReady();
        }

        // 提示词文本解析函数
        function parsePromptText(text) {
            const result = {};
            
            // 按行分割文本
            const lines = text.split('\n');
            let currentCategory = null;
            let currentContent = [];
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                // 检查是否是分类标题
                let foundCategory = null;
                for (const [key, mapping] of Object.entries(categoryMapping)) {
                    for (const pattern of mapping.patterns) {
                        if (pattern.test(line)) {
                            foundCategory = key;
                            break;
                        }
                    }
                    if (foundCategory) break;
                }
                
                if (foundCategory) {
                    // 保存之前的分类内容
                    if (currentCategory && currentContent.length > 0) {
                        result[currentCategory] = {
                            content: currentContent.join(', '),
                            categoryName: categoryMapping[currentCategory].name,
                            categoryZh: categoryMapping[currentCategory].zhName
                        };
                    }
                    
                    // 开始新的分类
                    currentCategory = foundCategory;
                    currentContent = [];
                } else if (currentCategory && line) {
                    // 添加到当前分类的内容
                    currentContent.push(line);
                }
            }
            
            // 保存最后一个分类
            if (currentCategory && currentContent.length > 0) {
                result[currentCategory] = {
                    content: currentContent.join(', '),
                    categoryName: categoryMapping[currentCategory].name,
                    categoryZh: categoryMapping[currentCategory].zhName
                };
            }
            
            return result;
        }

        // 检查是否可以导入
        function checkImportReady() {
            const importBtn = document.getElementById('importBtn');
            const hasImage = selectedFiles.length > 0;
            const hasPrompts = document.getElementById('promptInput').value.trim().length > 0;
            const hasTitle = document.getElementById('entryTitle').value.trim().length > 0;
            
            importBtn.disabled = !hasImage || !hasPrompts || !hasTitle;
        }

        // 类别选择
        function toggleCategory(item) {
            const category = item.dataset.category;
            if (selectedCategories.has(category)) {
                selectedCategories.delete(category);
                item.classList.remove('selected');
            } else {
                selectedCategories.add(category);
                item.classList.add('selected');
            }
        }

        // 导入条目
        async function importEntry() {
            const title = document.getElementById('entryTitle').value.trim();
            const tagsInput = document.getElementById('entryTags').value.trim();
            const promptText = document.getElementById('promptInput').value.trim();
            
            console.log('开始导入:', { title, tagsInput, promptText: promptText.slice(0, 100) + '...', filesCount: selectedFiles.length });
            
            if (!title) {
                alert('请输入条目标题！');
                return;
            }

            if (selectedFiles.length === 0) {
                alert('请先选择图片文件！');
                return;
            }

            if (!promptText) {
                alert('请输入提示词文本！');
                return;
            }

            try {
                const parsedPrompts = parsePromptText(promptText);
                console.log('解析后的提示词:', parsedPrompts);
                
                if (Object.keys(parsedPrompts).length === 0) {
                    alert('未检测到有效的提示词分类，请检查格式！\n\n请确保使用正确的分类标签格式，例如：\n[Base Styles / 基础风格]\n[Artistic Styles / 画风表现]\n等等...');
                    return;
                }

                // 处理标签
                const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                console.log('处理后的标签:', tags);
                
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    console.log(`处理文件 ${i + 1}/${selectedFiles.length}:`, file.name);
                    
                    // 读取文件为 Data URL
                    const dataUrl = await fileToDataURL(file);
                    console.log('文件读取完成，大小:', dataUrl.length);
                    
                    // 保存图片到本地
                    const filenameBase = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    console.log('保存图片文件名:', filenameBase);
                    
                    const mediaResult = await window.api.saveMediaDataURL({ dataUrl, filenameBase });
                    console.log('图片保存结果:', mediaResult);
                    
                    if (!mediaResult.ok) {
                        throw new Error(mediaResult.error || '保存图片失败');
                    }
                    
                    // 创建新条目
                    const newEntry = {
                        id: Date.now() + Math.random() + i,
                        title: selectedFiles.length === 1 ? title : `${title} - ${file.name.replace(/\.[^/.]+$/, "")}`,
                        imagePath: mediaResult.path,
                        tags: [...tags, '导入'],
                        prompts: {},
                        createdAt: new Date().toISOString()
                    };

                    // 转换解析后的提示词格式
                    Object.entries(parsedPrompts).forEach(([key, data]) => {
                        newEntry.prompts[key] = {
                            en: data.content,
                            zh: data.categoryZh
                        };
                    });

                    console.log('创建的条目:', newEntry);
                    entries.unshift(newEntry);
                }
                
                console.log('保存条目到数据库...');
                await saveEntries();
                console.log('更新 filteredEntries...');
                filteredEntries = [...entries];  // 重要：更新过滤数组
                console.log('更新显示...');
                updateDisplay();
                clearAll();
                showMessage('成功导入 ' + selectedFiles.length + ' 个条目！');
                
            } catch (error) {
                console.error('导入失败详细错误:', error);
                alert(`导入失败: ${error.message}\n\n请检查控制台获取详细错误信息。`);
            }
        }

        // 添加示例数据
        function addSampleData() {
            const sampleEntries = [
                {
                    id: Date.now() + 1,
                    title: "动漫女孩示例",
                    imagePath: createPlaceholderImage("示例图片 1"),
                    tags: ['示例', '动漫', '女孩'],
                    prompts: {
                        base_styles: {
                            en: "anime style, bishoujo character, Demon Slayer illustration",
                            zh: "基础风格"
                        },
                        artistic_styles: {
                            en: "cel shading, manga lineart, vibrant pastel tones",
                            zh: "画风表现"
                        },
                        rendering: {
                            en: "hyper-detailed, 8K resolution, subsurface scattering for skin",
                            zh: "渲染技术"
                        }
                    },
                    createdAt: new Date().toISOString()
                },
                {
                    id: Date.now() + 2,
                    title: "战斗场景示例", 
                    imagePath: createPlaceholderImage("示例图片 2"),
                    tags: ['示例', '战斗', '特效'],
                    prompts: {
                        cinematic: {
                            en: "cinematic composition, dynamic action shot, ultra-realistic rim lighting",
                            zh: "摄影感"
                        },
                        lighting_mood: {
                            en: "glowing pastel light, soft bloom effect, moonlit battlefield atmosphere",
                            zh: "光影氛围"
                        },
                        effects: {
                            en: "floating cherry blossoms, glowing energy ribbons, heart-shaped sparks",
                            zh: "特效元素"
                        }
                    },
                    createdAt: new Date().toISOString()
                }
            ];
            
            entries.unshift(...sampleEntries);
            filteredEntries = [...entries];  // 重要：更新过滤数组
            saveEntries();
            updateDisplay();
            showMessage('已添加示例数据！');
        }

        // 清空所有
        function clearAll() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('entryTitle').value = '';
            document.getElementById('entryTags').value = '';
            document.getElementById('promptInput').value = '';
            document.getElementById('importBtn').disabled = true;
            
            // 重置上传区域
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">📁</div>
                <p>拖拽图片到此处，或点击选择文件</p>
                <p style="font-size: 0.9rem; color: #6c757d; margin-top: 10px;">
                    支持 PNG, JPG, JPEG, WebP 格式
                </p>
            `;
            
            // 重置预览区域
            const preview = document.getElementById('promptPreview');
            preview.innerHTML = '<p class="empty">请输入提示词文本...</p>';
            preview.className = 'prompt-preview empty';
        }

        // 搜索功能
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedTags = Array.from(document.querySelectorAll('.tag.selected')).map(tag => tag.textContent);
            
            filteredEntries = entries.filter(entry => {
                const matchesSearch = !searchTerm || 
                    entry.title.toLowerCase().includes(searchTerm) ||
                    entry.tags.some(tag => tag.toLowerCase().includes(searchTerm)) ||
                    Object.values(entry.prompts).some(prompt => 
                        prompt.en.toLowerCase().includes(searchTerm) ||
                        prompt.zh.toLowerCase().includes(searchTerm)
                    );
                
                const matchesTags = selectedTags.length === 0 || 
                    selectedTags.some(tag => entry.tags.includes(tag));
                
                return matchesSearch && matchesTags;
            });
            
            currentPage = 1;
            updateDisplay();
        }

        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.tag.selected').forEach(tag => tag.classList.remove('selected'));
            filteredEntries = [...entries];
            currentPage = 1;
            updateDisplay();
        }

        // 更新显示
        function updateDisplay() {
            console.log('updateDisplay called');
            console.log('entries.length:', entries.length);
            console.log('filteredEntries.length:', filteredEntries.length);
            console.log('Current entries:', entries);
            console.log('Current filteredEntries:', filteredEntries);
            
            updateStats();
            updateEntriesGrid();
            updatePagination();
            updateTagFilter();
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            const totalPages = Math.ceil(filteredEntries.length / itemsPerPage);
            stats.innerHTML = `
                <strong>总条目: ${entries.length}</strong> | 
                <strong>当前显示: ${filteredEntries.length}</strong> | 
                <strong>第 ${currentPage} 页，共 ${totalPages} 页</strong>
            `;
        }

        function updateEntriesGrid() {
            const grid = document.getElementById('entriesGrid');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageEntries = filteredEntries.slice(startIndex, endIndex);

            if (pageEntries.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>暂无数据</h3>
                        <p>上传一些图片并生成提示词来开始使用吧！</p>
                        <p>或者点击"添加示例数据"来查看效果。</p>
                    </div>
                `;
                return;
            }

            console.log('Rendering entries:', pageEntries.length, 'entries');
            
            grid.innerHTML = pageEntries.map(entry => {
                console.log('Rendering entry:', entry.title, 'with prompts:', Object.keys(entry.prompts));
                return `
                <div class="entry-card">
                    <img src="${resolveImagePath(entry.imagePath)}" alt="${entry.title}" class="entry-image" onerror="this.src='${createPlaceholderImage(entry.title)}'">
                    <div class="entry-content">
                        <div class="entry-title">${entry.title}</div>
                        <div class="entry-tags">
                            ${entry.tags.map(tag => `<span class="entry-tag">${tag}</span>`).join('')}
                        </div>
                        ${Object.entries(entry.prompts).map(([category, prompt]) => `
                            <div class="prompt-section">
                                <div class="prompt-category">${getCategoryName(category)}</div>
                                <div class="prompt-text" onclick="copyToClipboard('${escapeHtml(prompt.en)}')" title="点击复制英文提示词">${prompt.en}</div>
                                <div class="prompt-chinese">${prompt.zh}</div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn" onclick="editEntry('${entry.id}')">✏️ 编辑</button>
                            <button class="copy-btn" onclick="copyAllPromptsForEntry('${entry.id}')">📋 复制全部</button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredEntries.length / itemsPerPage);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // 上一页
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="goToPage(${currentPage - 1})">上一页</button>`;
            }
            
            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += `<span class="page-btn">...</span>`;
                }
            }
            
            // 下一页
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="goToPage(${currentPage + 1})">下一页</button>`;
            }
            
            pagination.innerHTML = paginationHTML;
        }

        function updateTagFilter() {
            // 收集所有标签
            allTags.clear();
            entries.forEach(entry => {
                entry.tags.forEach(tag => allTags.add(tag));
            });

            const tagFilter = document.getElementById('tagFilter');
            if (allTags.size > 0) {
                tagFilter.innerHTML = Array.from(allTags).map(tag => 
                    `<span class="tag" onclick="toggleTag(this)">${tag}</span>`
                ).join('');
            } else {
                tagFilter.innerHTML = '<p style="color: #6c757d;">暂无标签</p>';
            }
        }

        // 工具函数
        function toggleTag(tagElement) {
            tagElement.classList.toggle('selected');
            performSearch();
        }

        function goToPage(page) {
            currentPage = page;
            updateDisplay();
        }

        function getCategoryName(category) {
            return categoryMapping[category]?.name || category;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('提示词已复制到剪贴板！');
            }).catch(err => {
                console.error('复制失败:', err);
            });
        }

        function showMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            document.querySelector('.container').insertBefore(messageDiv, document.querySelector('.upload-section'));
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function createPlaceholderImage(text) {
            return `data:image/svg+xml;base64,${btoa(`
                <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100%" height="100%" fill="#f8f9fa"/>
                    <text x="50%" y="50%" font-family="Arial" font-size="14" fill="#6c757d" text-anchor="middle" dy=".3em">${text}</text>
                </svg>
            `)}`;
        }

        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 数据持久化
        async function loadEntries() {
            try {
                console.log('Loading entries from API...');
                const data = await window.api.listEntries();
                console.log('Loaded data from API:', data);
                
                entries = Array.isArray(data) ? data : [];
                filteredEntries = [...entries];
                
                console.log('Set entries:', entries.length);
                console.log('Set filteredEntries:', filteredEntries.length);
                
                updateDisplay();
            } catch (error) {
                console.error('Failed to load entries:', error);
                entries = [];
                filteredEntries = [];
                updateDisplay();
            }
        }

        async function saveEntries() {
            try {
                await window.api.saveEntries(entries);
            } catch (error) {
                console.error('Failed to save entries:', error);
            }
        }

        // 图片路径解析
        function resolveImagePath(imagePath) {
            if (imagePath.startsWith('file://') || imagePath.startsWith('data:')) {
                return imagePath;
            }
            // 对于相对路径，需要通过API解析
            return imagePath;
        }

        // 编辑条目
        let currentEditingEntry = null;

        function editEntry(entryId) {
            const entry = entries.find(e => e.id == entryId);
            if (!entry) return;
            
            currentEditingEntry = entry;
            
            // 显示标签
            updateEditTags();
            
            // 显示提示词类别
            updateEditCategories();
            
            // 显示模态框
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditingEntry = null;
        }

        function updateEditTags() {
            if (!currentEditingEntry) return;
            
            const container = document.getElementById('editTags');
            container.innerHTML = currentEditingEntry.tags.map(tag => `
                <div class="tag-chip">
                    ${tag}
                    <button class="tag-remove" onclick="removeTag('${tag}')">×</button>
                </div>
            `).join('');
        }

        function updateEditCategories() {
            if (!currentEditingEntry) return;
            
            const container = document.getElementById('editCategories');
            container.innerHTML = Object.entries(currentEditingEntry.prompts).map(([category, prompt]) => `
                <div class="edit-category">
                    <h4>${getCategoryName(category)}</h4>
                    <textarea class="edit-textarea" data-category="${category}" data-lang="en">${prompt.en}</textarea>
                    <div class="edit-zh">中文说明: ${prompt.zh}</div>
                    <div class="copy-buttons">
                        <button class="copy-btn" onclick="copyToClipboard('${escapeHtml(prompt.en)}')">复制英文</button>
                    </div>
                </div>
            `).join('');
        }

        function addTag() {
            const input = document.getElementById('newTagInput');
            const tag = input.value.trim();
            
            if (tag && !currentEditingEntry.tags.includes(tag)) {
                currentEditingEntry.tags.push(tag);
                updateEditTags();
                input.value = '';
            }
        }

        function removeTag(tag) {
            if (!currentEditingEntry) return;
            currentEditingEntry.tags = currentEditingEntry.tags.filter(t => t !== tag);
            updateEditTags();
        }

        function saveEntry() {
            if (!currentEditingEntry) return;
            
            // 更新提示词内容
            const textareas = document.querySelectorAll('.edit-textarea');
            textareas.forEach(textarea => {
                const category = textarea.dataset.category;
                const lang = textarea.dataset.lang;
                if (currentEditingEntry.prompts[category]) {
                    currentEditingEntry.prompts[category][lang] = textarea.value;
                }
            });
            
            filteredEntries = [...entries];  // 重要：更新过滤数组
            saveEntries();
            updateDisplay();
            closeEditModal();
            showMessage('条目已保存！');
        }

        function deleteEntry() {
            if (!currentEditingEntry) return;
            
            if (confirm('确定要删除这个条目吗？此操作不可撤销。')) {
                entries = entries.filter(e => e.id !== currentEditingEntry.id);
                filteredEntries = [...entries];  // 重要：更新过滤数组
                saveEntries();
                updateDisplay();
                closeEditModal();
                showMessage('条目已删除！');
            }
        }

        function copyAllPrompts() {
            if (!currentEditingEntry) return;
            
            const allPrompts = Object.values(currentEditingEntry.prompts)
                .map(prompt => prompt.en)
                .join(', ');
            
            copyToClipboard(allPrompts);
        }

        function copyAllPromptsForEntry(entryId) {
            const entry = entries.find(e => e.id == entryId);
            if (!entry) return;
            
            const allPrompts = Object.values(entry.prompts)
                .map(prompt => prompt.en)
                .join(', ');
            
            copyToClipboard(allPrompts);
        }

        // 数据管理功能
        async function exportData() {
            try {
                const result = await window.api.exportJSON(entries);
                if (result.ok) {
                    showMessage(`数据已导出到: ${result.path}`);
                } else {
                    alert('导出失败: ' + result.error);
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('导出失败: ' + error.message);
            }
        }

        async function importData() {
            try {
                const result = await window.api.importJSON();
                if (result.ok) {
                    if (confirm('导入数据将覆盖当前所有数据，确定继续吗？')) {
                        entries = Array.isArray(result.data) ? result.data : [];
                        filteredEntries = [...entries];  // 确保过滤数组同步
                        await saveEntries();
                        updateDisplay();
                        showMessage('数据导入成功！');
                    }
                } else if (result.error !== 'Cancelled') {
                    alert('导入失败: ' + result.error);
                }
            } catch (error) {
                console.error('Import error:', error);
                alert('导入失败: ' + error.message);
            }
        }

        async function openDataDir() {
            try {
                await window.api.openUserData();
            } catch (error) {
                console.error('Open directory error:', error);
                alert('无法打开数据目录: ' + error.message);
            }
        }
    </script>
</body>
</html>
